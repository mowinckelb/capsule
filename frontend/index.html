<!DOCTYPE html>
<html>
<head>
    <title>Capsule</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, button { margin: 5px; }
        #app { display: none; }
    </style>
</head>
<body>
    <h1>Capsule</h1>
    <div id="auth">
        <h2>Login/Register</h2>
        <input id="user_id" placeholder="User ID">
        <input id="password" type="password" placeholder="Password">
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
        <p id="auth_error"></p>
    </div>
    <div id="app">
        <h2>Authenticated as <span id="user"></span></h2>
        <input id="command" placeholder="input: <memory> or output: <question>">
        <button onclick="sendCommand()">Submit</button>
        <p id="output"></p>
    </div>
    <script>
        let token = "";
        async function register() {
            const user_id = document.getElementById("user_id").value;
            const password = document.getElementById("password").value;
            try {
                const response = await fetch("https://capsule-i25c.onrender.com/api/register", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: `user_id=${encodeURIComponent(user_id)}&password=${encodeURIComponent(password)}`
                });
                const data = await response.json();
                document.getElementById("auth_error").innerText = data.status || data.detail;
            } catch (e) {
                document.getElementById("auth_error").innerText = "Error: Unable to connect";
            }
        }
        async function login() {
            const user_id = document.getElementById("user_id").value;
            const password = document.getElementById("password").value;
            try {
                const response = await fetch("https://capsule-i25c.onrender.com/api/login", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: `username=${encodeURIComponent(user_id)}&password=${encodeURIComponent(password)}`
                });
                const data = await response.json();
                if (data.access_token) {
                    token = data.access_token;
                    document.getElementById("user").innerText = user_id;
                    document.getElementById("auth").style.display = "none";
                    document.getElementById("app").style.display = "block";
                } else {
                    document.getElementById("auth_error").innerText = data.detail;
                }
            } catch (e) {
                document.getElementById("auth_error").innerText = "Error: Unable to connect";
            }
        }
        async function sendCommand() {
            const command = document.getElementById("command").value;
            let endpoint = "", body = "", method = "";
            if (command.startsWith("input:")) {
                endpoint = "https://capsule-i25c.onrender.com/api/add";
                body = `memory=${encodeURIComponent(command.slice(6).trim())}`;
                method = "POST";
            } else if (command.startsWith("output:")) {
                endpoint = `https://capsule-i25c.onrender.com/api/query?q=${encodeURIComponent(command.slice(7).trim())}`;
                method = "GET";
            } else {
                document.getElementById("output").innerText = "Use 'input: <memory>' or 'output: <question>'";
                return;
            }
            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        ...(method === "POST" ? {"Content-Type": "application/x-www-form-urlencoded"} : {})
                    },
                    ...(method === "POST" ? {body: body} : {})
                });
                const data = await response.json();
                document.getElementById("output").innerText = method === "POST" ? data.status : JSON.stringify(data.results);
            } catch (e) {
                document.getElementById("output").innerText = "Error: Unable to process";
            }
        }
    </script>
</body>
</html>